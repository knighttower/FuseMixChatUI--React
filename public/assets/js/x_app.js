(()=>{"use strict";var e,t={680:(e,t,s)=>{var n=s(540),r=s(338),a=s(349),o=s(862);const c=new(s(481).l);var l=s(691),i=s(454);const u=(0,i.og)("chat-connections",{},{encode:JSON.stringify,decode:JSON.parse}),m=(0,i.og)("chat-usage",{},{encode:JSON.stringify,decode:JSON.parse}),d={addMessage(e,t){const s=u.get(),n=s[e]||[];u.set({...s,[e]:[...n,t]})},addUsage(e,t){const s=m.get(),n=s[e]||[];m.set({...s,[e]:[...n,t]})},updateMessageById(e,t,s){const n=u.get(),r=n[e];if(!r){return!1}const a=r.findIndex((e=>e.id===t));if(-1===a){return!1}const o=[...r];return o[a]={...o[a],message:s},u.set({...n,[e]:o}),!0},clearHistory(e){const t=u.get();u.set({...t,[e]:[]})},clearHistoryAll(){u.set({}),m.set({}),localStorage.removeItem("chat-connections"),localStorage.removeItem("chat-usage")},getHistory(e){const t=u.get();return t[e]?[...t[e]]:[]},getReadHistory:e=>d.getHistory(e).map((e=>`${e.user}: ${e.message}`)).join("\n"),getLastMessage(e){const t=d.getHistory(e);return 0===t.length?null:t[t.length-1]},getMessageById:(e,t)=>d.getHistory(e).find((e=>e.id===t))||null};var h=s(132);function g(){const e=(0,l.P)(u);return n.createElement(n.Fragment,null,n.createElement("div",{className:"reset"},n.createElement("button",{className:"chat-reset",onClick:()=>{c.emit("chat/history/clear","all"),h.A.success("Chat history cleared successfully!")}},"Clear History")),n.createElement("div",{className:" space-y-4"},Object.entries(e).map((e=>{let[t,s]=e;return n.createElement("div",{key:t,className:"chat__history__entry p-4 border rounded-lg"},n.createElement("h4",{className:"font-bold mb-2 color-purple"},"Chat ID: ",t),0===s.length?n.createElement("p",{className:"text-gray-500"},"No messages"):n.createElement("ul",{className:"space-y-1"},s.map((e=>n.createElement("li",{key:e.id,className:"text-sm"},n.createElement("span",{className:"font-semibold"},e.user,":")," ",e.message)))),n.createElement("hr",null))}))))}const f=(0,i.RO)("websocketUrl","",{encode:JSON.stringify,decode:JSON.parse});function p(){const e=(0,l.P)(f),[t,s]=(0,n.useState)("");(0,n.useEffect)((()=>{s(e)}),[e]);return n.createElement("section",{className:"p-4"},n.createElement("label",{htmlFor:"websocketUrl",className:"pb-2 block"},"Enter WebSocket URL (",n.createElement("code",null,"ws://")," or ",n.createElement("code",null,"wss://"),"):"),n.createElement("input",{type:"text",name:"websocketUrl",value:t,onChange:e=>s(e.target.value),placeholder:"ws://example.com/socket",className:"w-full p-2 border rounded mb-4",pattern:"^(ws|wss):\\\\/\\\\/.+$",title:"Enter a valid WebSocket URL (ws:// or wss://)",required:!0}),n.createElement("button",{className:"p-button p-component p-button-outlined w-150px text-align-center block",onClick:()=>{try{let e=t.trim();/^wss?:\/\//i.test(e)||(e="ws://"+e);const n=e.match(/^(wss?):\/\/(.+)$/i);if(!n||!n[1]||!n[2]){return void h.A.error("Invalid WebSocket URL format")}const r=`${n[1].toLowerCase()}://${n[2].replace(/\/+$/,"").replace(/[^\w.-:/]/g,"")}`;if(!/^wss?:\/\/[\w.-]+(:\d+)?(\/[\w./-]*)?$/i.test(r)){return void h.A.error("Invalid WebSocket URL")}s(r),f.set(r),h.A.success("Settings saved successfully!")}catch(e){console.error(e),h.A.error("Error processing URL")}}},"Save Settings"))}var b=s(400);const y=e=>{let{message:t,isUser:s}=e;const r=(0,n.useMemo)((()=>new b.A),[]),a=(0,n.useMemo)((()=>r.render(t||"")),[r,t]),o=()=>{document.querySelectorAll(".chat__message:not(.--user) .chat__message__content").forEach((e=>{const t=e.parentElement;if(!t.querySelector(".copy-button")){const s=document.createElement("button");s.innerHTML="Copy",s.setAttribute("class","chat__copy-button"),s.addEventListener("click",(()=>{var t;h.A.success("Copied!"),t=e.textContent,navigator.clipboard.writeText(t).then((()=>{window.$toast?.push?.({message:"Copied!",type:"success",closeButton:!0})}),(e=>{alert("Could not copy text: "+e)}))})),t.appendChild(s)}}))},c=()=>{document.querySelectorAll(".copy-button").forEach((e=>e.remove()))};return(0,n.useEffect)((()=>(c(),o(),()=>{c()})),[a]),n.createElement("div",{className:"chat__message "+(s?"--user":"")},n.createElement("div",{className:"chat__message__tag"},n.createElement("small",null,s?"-- user --":"-- agent --")),n.createElement("div",{className:"chat__message__content",dangerouslySetInnerHTML:{__html:a}}))};var E=s(937),v=s(987);const w=new(s(431).A);function _(){const[e,t]=(0,n.useState)(""),[s,r]=(0,n.useState)(!1);(0,n.useEffect)((()=>{const e=()=>t(""),s=()=>r(!1);return c.on("chat/new",e),c.on("chat/resetEditor",e),c.on("chat/agentHasCompleted",s),()=>{c.off("chat/resetEditor",e),c.off("chat/agentHasCompleted",s),c.off("chat/new",e)}}),[]);return n.createElement("section",{className:"chat__input-area w-100% pt-1"},n.createElement(E.K,{value:e,onTextChange:e=>t(e.htmlValue),style:{minHeight:"80px",maxHeight:"150px",overflowY:"auto"},placeholder:"Type your message here...",modules:{toolbar:[["code-block"],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],["clean"]]},headerTemplate:n.createElement(n.Fragment,null)}),n.createElement("div",{className:"chat__input-area__trigger"},n.createElement(v.$,{onClick:()=>{r(!0);const t=(s=e,w.turndown(s));var s;c.emit("chat/send/userMsg",t)},disabled:s,className:"input-area__button btn--small "+(s?"btn--disabled":""),label:s?"Processing...":"Send"})))}var N=s(669);function S(){const e=new Date;return`${(0,N.uR)(4)}--${e.getTime()}`}const k={"x-chat":function(){const e=(0,l.P)(f),t=(0,l.P)(u),[s,r]=(0,n.useState)([]),a=(0,n.useRef)(null),[o,i]=(0,n.useState)(!1),m=(0,n.useRef)(S()),h=(0,n.useRef)(null),g=e=>{if(!e||!a.current){return}const t=m.current,s={message:e,user:"user",id:(0,N.pM)()};d.addMessage(t,s),r(d.getHistory(t)),a.current.send(e)},p=e=>{const t=m.current;"all"===e&&(d.clearHistoryAll(),r([]),c.emit("chat/new")),e===t&&(d.clearHistory(t),r([])),c.emit("chat/resetEditor"),c.emit("chat/agentHasCompleted")},b=()=>{const e=a.current;e&&(e.onopen=e.onmessage=e.onclose=e.onerror=null,e.close(1e3,"New session")),a.current=null;const t=S();m.current=t,d.clearHistory(t),r([]),console.log("New chat session started with ID:",t),E()},E=()=>{if(!e){return}const t=new WebSocket(e);t.onopen=()=>{i(!0),a.current=t,console.log("Chat Connected to server"),c.emit("websocket/ready")},t.onmessage=e=>{let t,s=e.data,n=s;if("string"==typeof s){try{n=JSON.parse(s)}catch{console.warn("Raw data is plain string, not JSON:",s)}}if("object"==typeof n&&null!==n){const e=n.response??n;t="object"==typeof e&&null!==e&&(e.text||e.response)||e}else{t=n}let a;switch((0,N.QP)(t)){case"string":a=t.trim('"');break;case"number":case"boolean":case"null":case"undefined":case"integer":a=String(t);break;default:try{a=JSON.stringify(t)}catch{a="[Unserializable response]"}}const o=m.current,l=d.getLastMessage(o);if("assistant"===l?.user){const e=[l.message,a].join("");d.updateMessageById(o,l.id,e)}else{d.addMessage(o,{message:a,user:"assistant",id:(0,N.pM)()})}r(d.getHistory(o)),c.emit("chat/resetEditor"),c.emit("chat/agentHasCompleted")},t.onerror=e=>{i(!1),console.error("Chat WebSocket error:",e),c.emit("websocket/error",e),t.close()},t.onclose=()=>{i(!1),console.log("Chat Disconnected from server"),c.emit("websocket/closed")}};return(0,n.useEffect)((()=>{if(!e){return}E(),c.on("chat/send/userMsg",g),c.on("chat/history/clear",p),c.on("chat/new",b);const s=m.current;return t[s]&&r([...t[s]]),()=>{const e=a.current;e&&(e.onopen=e.onmessage=e.onclose=e.onerror=null,e.close(1e3,"Component unmount")),a.current=null,c.off("chat/send/userMsg",g),c.off("chat/history/clear",p),c.off("chat/new",b),c.emit("websocket/closed")}}),[e]),(0,n.useEffect)((()=>{h.current&&h.current.scrollIntoView({behavior:"smooth"})}),[s]),e?n.createElement("div",{className:"chat__window"},n.createElement("div",{className:"chat__messages max-h100 pb-5"},s.map(((e,t)=>n.createElement(y,{key:t,message:e.message,isUser:"user"===e.user}))),n.createElement("div",{ref:h})),o?n.createElement("div",{className:"chat__inputs"},n.createElement(_,null)):n.createElement("h3",{className:"chat__disconnected"},"Waiting for server connection...")):n.createElement("div",{className:"chat-window"},"Missing WebSocket URL in settings.")},"x-sidebar":function(){const[e,t]=(0,n.useState)(!1),[s,r]=(0,n.useState)(!1);return n.createElement("section",{className:"sidebar w-100"},n.createElement("menu",{className:"sidebar__menu list-none"},n.createElement("li",null,n.createElement("a",{href:"#",className:"logo",onClick:e=>e.preventDefault()},n.createElement("svg",{className:"x-icon",style:{width:"100px",height:"25px"}},n.createElement("use",{href:"assets/images/fx-SVG-sprite.svg#fx-logo"})))),n.createElement("li",null,n.createElement("a",{href:"#",className:"sidebar__action",onClick:e=>{e.preventDefault(),c.emit("chat/new"),console.log("New chat started"),h.A.success("New chat started successfully!")}},"New Chat ++")),n.createElement("li",null,n.createElement("a",{href:"#",className:"sidebar__action",onClick:e=>{e.preventDefault(),t(!0)}},"History")),n.createElement("li",null,n.createElement("a",{href:"#",className:"sidebar__action",onClick:e=>{e.preventDefault(),r(!0)}},"Settings"))),n.createElement(o.B,{visible:e,onHide:()=>t(!1),header:"Chat History",position:"left",className:"chat__history",style:{width:"70%",minWidth:"300px"}},n.createElement(g,null)),n.createElement(o.B,{visible:s,onHide:()=>r(!1),header:"Settings",position:"left",className:"chat__settings",style:{width:"400px"}},n.createElement(p,null)))}};Object.entries(k).forEach((e=>{let[t,s]=e;document.querySelectorAll(t).forEach((e=>{r.createRoot(e).render(n.createElement(a.mD,null,n.createElement(s,null)))}))}))}},s={};function n(e){var r=s[e];if(void 0!==r){return r.exports}var a=s[e]={id:e,loaded:!1,exports:{}};return t[e](a,a.exports,n),a.loaded=!0,a.exports}n.m=t,e=[],n.O=(t,s,r,a)=>{if(!s){var o=1/0;for(u=0;u<e.length;u++){for(var[s,r,a]=e[u],c=!0,l=0;l<s.length;l++){(!1&a||o>=a)&&Object.keys(n.O).every((e=>n.O[e](s[l])))?s.splice(l--,1):(c=!1,a<o&&(o=a))}if(c){e.splice(u--,1);var i=r();void 0!==i&&(t=i)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--){e[u]=e[u-1]}e[u]=[s,r,a]},n.d=(e,t)=>{for(var s in t){n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})}},n.e=()=>Promise.resolve(),n.g=function(){if("object"==typeof globalThis){return globalThis}try{return this||new Function("return this")()}catch(e){if("object"==typeof window){return window}}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={249:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var r,a,[o,c,l]=s,i=0;if(o.some((t=>0!==e[t]))){for(r in c){n.o(c,r)&&(n.m[r]=c[r])}if(l){var u=l(n)}}for(t&&t(s);i<o.length;i++){a=o[i],n.o(e,a)&&e[a]&&e[a][0](),e[a]=0}return n.O(u)},s=self.webpackChunk_knighttower_chat_ui=self.webpackChunk_knighttower_chat_ui||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var r=n.O(void 0,[96],(()=>n(680)));r=n.O(r);var a=window;for(var o in r){a[o]=r[o]}r.__esModule&&Object.defineProperty(a,"__esModule",{value:!0})})();